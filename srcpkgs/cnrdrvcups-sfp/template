# Template file for 'cnrdrvcups-sfp'
pkgname=cnrdrvcups-sfp
version=5.00
revision=1
archs="i686 x86_64"
create_wrksrc=yes
build_wrksrc=source
_common_dir=cnrdrvcups-common-${version}
_driver_dir=${pkgname}-${version}
hostmakedepends="autoconf automake glib-devel gettext libtool libxml2-devel pkg-config"
makedepends="atk-devel cups-devel gtk+-devel libglade-devel"
depends="colord cups cups-filters eudev libglade libusb"
short_desc="UFRII LT printer driver for Canon LBP printers"
maintainer="Kamil Smardzewski <roderyk197@gmail.com>"
license="custom:canon,GPL-2.0-or-later,MIT"
homepage="https://www.canon-europe.com/support/consumer_products/products/printers/laser/i-sensys_lbp6030w.html?type=drivers&language=en&os=linux%20(64-bit)"
distfiles="https://gdlp01.c-wss.com/gds/0/0100005950/10/linux-UFRIILT-drv-v500-uken-18.tar.gz"
checksum="46888140016bc1096694a0fd6fd3f6ad393970b8153756373a382dc82390f259"
repository="nonfree"
nopie=yes

case $XBPS_TARGET_MACHINE in
	x86_64)
		_bits=64
		;;
	i686)
		_bits=32
		;;
esac

CFLAGS="-fcommon"

post_extract() {
	mkdir ${build_wrksrc}
	bsdtar xvf linux-UFRIILT-drv-v500-uken/Sources/${pkgname}-${version}-1.tar.gz -C ${build_wrksrc}
}

pre_configure() {
	vsed -e '2a export LIBS="-lgtk-x11-2.0 -lgobject-2.0 -lglib-2.0 -lgmodule-2.0"' -i "${_common_dir}/cngplp/autogen.sh"
	vsed -e '2a export LIBS="-latk-1.0 -lgobject-2.0 -lglib-2.0 -lgdk_pixbuf-2.0 -lcups"' -i "${_driver_dir}/StatusMonitor/autogen.sh"

	for subdir in "buftool" "cngplp" "cnjbig" "rasterfilter"
	do
		( cd ${_common_dir}/${subdir} && autoreconf -i )
	done

	for subdir in "cngplp/files" "cngplp" "cpca" "ppd" "StatusMonitor"
	do
		( cd ${_driver_dir}/${subdir} && autoreconf -i )
	done
}

do_configure() {
	local _buftool_abs_path="${wrksrc}/${build_wrksrc}/${_common_dir}/buftool"

	( cd ${_common_dir}/buftool && ./autogen.sh ${configure_args} --enable-progpath=/usr/bin --disable-shared --enable-static )
	( cd ${_common_dir}/cngplp && ./autogen.sh ${configure_args} COMMON_SUFFIX=2l )
	( cd ${_common_dir}/cnjbig && ./autogen.sh ${configure_args} )
	( cd ${_common_dir}/rasterfilter && LDFLAGS="-L${_buftool_abs_path} -no-pie" ./autogen.sh ${configure_args} )

	( cd ${_driver_dir}/ppd && ./autogen.sh ${configure_args} )
	( cd ${_driver_dir}/cngplp && ./autogen.sh ${configure_args} --prefix=/usr )
	( cd ${_driver_dir}/cngplp/files && ./autogen.sh ${configure_args} )
	( cd ${_driver_dir}/StatusMonitor && LDFLAGS="-L${_buftool_abs_path} -no-pie" ./autogen.sh ${configure_args} --enable-progpath=/usr/bin )
	( cd ${_driver_dir}/cpca && ./autogen.sh ${configure_args} --enable-progpath=/usr/bin )
}

do_build() {
	( cd ${_common_dir} && make all )
	( cd ${_driver_dir} && make all )
}

pre_install() {
	cd "lib/libs${_bits}"

	rm "libcanon_slimsfp.so" "libcanon_slimsfp.so.1"
	rm "libinfor.so" "libinfor.so.1"

	ln -s libcaepcmsfp.so.1.0 libcaepcmsfp.so.1
	ln -s libcanon_slimsfp.so.1.0.0 libcanon_slimsfp.so.1
	ln -s libcanon_slimsfp.so.1.0.0 libcanon_slimsfp.so
	ln -s libColorGearCsfp.so.2.0.0 libColorGearCsfp.so.2
	ln -s libColorGearCsfp.so.2.0.0 libColorGearCsfp.so

	ln -s libccpd_utilr.so.1.0.0 libccpd_utilr.so
	ln -s libccpd_utilr.so.1.0.0 libccpd_utilr.so.1
	ln -s libcomm_stdoutr.so.1.0.0 libcomm_stdoutr.so
	ln -s libcomm_stdoutr.so.1.0.0 libcomm_stdoutr.so.1
	ln -s libcomm_usbmlportr.so.1.0.0 libcomm_usbmlportr.so
	ln -s libcomm_usbmlportr.so.1.0.0 libcomm_usbmlportr.so.1
	ln -s libcomm_usbsockr.so.1.0.0 libcomm_usbsockr.so
	ln -s libcomm_usbsockr.so.1.0.0 libcomm_usbsockr.so.1
	ln -s libcomm_websrvr.so.1.0.0 ibcomm_websrvr.so
	ln -s libcomm_websrvr.so.1.0.0 ibcomm_websrvr.so.1
	ln -s libcomm_ncapcaior.so.1.0.0 libcomm_ncapcaior.so
	ln -s libcomm_ncapcaior.so.1.0.0 libcomm_ncapcaior.so.1
	ln -s libcaio_usb_cdcr.so.1.0.0 libcaio_usb_cdcr.so
	ln -s libcaio_usb_cdcr.so.1.0.0 libcaio_usb_cdcr.so.1

	ln -s libCUPS_Communicatorr.so.1.0.0 libCUPS_Communicatorr.so
	ln -s libCUPS_Communicatorr.so.1.0.0 libCUPS_Communicatorr.so.1
	ln -s libCommIsolationr.so.1.0.0 libCommIsolationr.so
	ln -s libCommIsolationr.so.1.0.0 libCommIsolationr.so.1
	ln -s libcanon_commonr.so.1.0.0 libcanon_commonr.so
	ln -s libcanon_commonr.so.1.0.0 libcanon_commonr.so.1
	ln -s libinfor.so.1.0.0 libinfor.so
	ln -s libinfor.so.1.0.0 libinfor.so.1
	ln -s libinfo_analyzer.so.1.0.0 libinfo_analyzer.so
	ln -s libinfo_analyzer.so.1.0.0 libinfo_analyzer.so.1
}

do_install() {
	for subdir in "buftool" "cngplp" "cnjbig" "rasterfilter"
	do
		( cd ${_common_dir}/${subdir} && make install DESTDIR=${DESTDIR} COMMON_SUFFIX=2 )
	done

	for subdir in "cngplp/files" "cngplp" "cpca" "ppd" "StatusMonitor"
	do
		( cd ${_driver_dir}/${subdir} && make install DESTDIR=${DESTDIR} )
	done

	pushd "lib/libs${_bits}"

	vbin cnsetuputil2l
	vcopy lib*.so* usr/lib


	for _locale in "de" "es" "fr" "it" "ja" "ko" "zh_CN" "zh_TW"
	do
		vmkdir usr/share/locale/${_locale}/LC_MESSAGES
		vinstall ${_locale}/LC_MESSAGES/cnsetuputil2l.mo 644 usr/share/locale/${_locale}/LC_MESSAGES
	done

	vmkdir usr/share/caepcm/sfp

	pushd ../data/sfp

	for _cnlb_file in CnLB*
	do
		vinstall ${_cnlb_file} 644 usr/share/caepcm/sfp
	done

	popd

	vmkdir usr/share/ncapfilterr
	vinstall ThLB_37A.BIN 644 usr/share/ncapfilterr

	popd

	vmkdir usr/lib/udev/rules.d
	vinstall ${_driver_dir}/rules/80-usb-ncapstatusui2l.rules 644 usr/lib/udev/rules.d
	
	vmkdir usr/share/cups/usb
	vinstall ${_driver_dir}/rules/canon-sfp-printerr.usb-quirks 644 usr/share/cups/usb

	vmkdir usr/share/applications
	vinstall cnrdrvcups-utility-5.00/data/cnsetuputil2l.desktop 644 usr/share/applications

	vmkdir usr/share/icons/hicolor/128x128/apps
	vinstall cnrdrvcups-utility-5.00/data/cnsetuputil.png 644 usr/share/icons/hicolor/128x128/apps

	vlicense ../linux-UFRIILT-drv-v500-uken/Documents/LICENSE-EN.txt LICENSE

	vlicense ${_common_dir}/cngplp/LICENSE.canon.txt LICENSE.cngplp
	vlicense ${_driver_dir}/StatusMonitor/LICENSE.canon.txt LICENSE.statusmonitor
	vlicense ${_driver_dir}/cpca/cnpklib/LICENSE.canon.txt LICENSE.cpca.cnpklib

	vdoc ../linux-UFRIILT-drv-v500-uken/Documents/README-ufr2lt-5.0xUK.html
	vdoc ../linux-UFRIILT-drv-v500-uken/Documents/UsersGuide-ufr2lt-UK.html

	vdoc ${_common_dir}/README README.common
	vdoc ${_common_dir}/cngplp/README README.cngplp.common
	vdoc ${_common_dir}/cnjbig/README README.cnjbig
	vdoc ${_common_dir}/rasterfilter/README README.rasterfilter

	vdoc ${_driver_dir}/README README.driver
	vdoc ${_driver_dir}/StatusMonitor/README README.statusmonitor
	vdoc ${_driver_dir}/cngplp/README README.cngplp.driver
	vdoc ${_driver_dir}/cngplp/files/README README.cngplp.files
	vdoc ${_driver_dir}/cpca/README README.cpca
	vdoc ${_driver_dir}/ppd/README README.ppd

	vdoc $FILESDIR/README.voidlinux
}
